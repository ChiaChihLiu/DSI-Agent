# PSI Rolling Forecast Skill

## æŠ€èƒ½èªªæ˜

**åç¨±**: `psi_rolling_forecast`

**èªªæ˜**: åŸ·è¡Œé€²éšçš„ PSI (é€²éŠ·å­˜) æ»¾å‹•åº«å­˜é æ¸¬

**è§¸ç™¼æ¢ä»¶** - ç•¶ç”¨æˆ¶æåˆ°ï¼š
- ã€Œä¾›æ‡‰èˆ‡éœ€æ±‚æ˜¯å¦å¹³è¡¡ã€
- ã€ŒSales forecast or purchase forecast ç•°å¸¸ã€
- ã€Œåº«å­˜æ˜¯ä¸æ˜¯éé«˜æˆ–éä½ã€
- ã€Œæ˜¯å¦æœ‰å‘†æ»¯åº«å­˜è¦è™•ç†ã€

---

## æ ¸å¿ƒå•†å‹™é‚è¼¯

| é …ç›® | èªªæ˜ |
|------|------|
| **è¨ˆç®—å…¬å¼** | æœŸæœ«åº«å­˜ = æœŸåˆåº«å­˜ + ä¾›æ‡‰ - éœ€æ±‚(t) |
| **è¼¸å‡ºè¦ç¯„** | å¿…é ˆéµå¾ªæ¨™æº– 9 æ¬„ä½æ ¼å¼ |
| **å¸¸ç”¨è³‡æ–™ä¾†æº** | `optw_dw_dsi_monthly_data_v` |

---

## SQL Query Template

### æŸ¥è©¢çµæ§‹ (Query Structure)

åŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿï¼š

1. Collect data by secondary model is `{XXXXXX}` for each region
2. Only data source is **"Begin Inventory"** with data type is **"FG + In Transit"** as "Begin Inventory", its bucket date is "Start Date"
3. Include data sources: **"Sales Forecast"**, **"ETA Purchase Forecast"** with bucket date after "Start Date"
4. Use "Begin Inventory" with "Sales Forecast" and "ETA Purchase Forecast" with arrived bucket date to calculate **"End Inventory"**
5. "End Inventory" of this bucket date will be the next bucket date "Begin Inventory"
6. Show output for detail table with border of running inventory

---

## åº«å­˜ç‹€æ…‹åˆ¤æ–·

| ç‹€æ…‹ | æ¢ä»¶ | åœ–ç¤º |
|------|------|------|
| é è¨ˆç¼ºè²¨ | æœŸæœ«åº«å­˜ < 0 | ğŸ”´ |
| ä½åº«å­˜è­¦å‘Š | æœŸæœ«åº«å­˜ < 30 | ğŸŸ¡ |
| æ­£å¸¸ | æœŸæœ«åº«å­˜ < 60 | ğŸŸ¢ |
| å¥åº· | æœŸæœ«åº«å­˜ >= 60 | ğŸŸ¢ |

---

## å»ºè­°æ¡è³¼é‡é‚è¼¯ (v1.6)

```
IF æœŸæœ«åº«å­˜ < 30 AND éœ€æ±‚ > 0 THEN
    å»ºè­°æ¡è³¼é‡ = 60 - æœŸæœ«åº«å­˜
ELSE
    å»ºè­°æ¡è³¼é‡ = NULL
END IF
```

---

## è¼¸å‡ºæ¬„ä½ (Output Columns)

| æ¬„ä½ | èªªæ˜ | è¨ˆç®—é‚è¼¯ |
|------|------|----------|
| `æœŸé–“` | é æ¸¬æœŸé–“ (YYYYMM) | - |
| `åº«å­˜åŸºæº–æ—¥` | åº«å­˜å¿«ç…§æ—¥æœŸ | ä¾†è‡ª `latest_valid_inventory_date` |
| `æœŸåˆåº«å­˜` | æœŸåˆåº«å­˜æ•¸é‡ | åˆå§‹åº«å­˜ + LAG(ç´¯ç©æ·¨è®Šå‹•) |
| `éœ€æ±‚` | Sales Forecast | ç•¶æœˆéŠ·å”®é æ¸¬ |
| `ä¾›æ‡‰` | Purchase Forecast | ç•¶æœˆæ¡è³¼é æ¸¬ (ETA) |
| `æœˆæ·¨è®Šå‹•` | æ·¨è®Šå‹• | ä¾›æ‡‰ - éœ€æ±‚ |
| `é è¨ˆæœŸæœ«åº«å­˜` | é è¨ˆæœŸæœ«åº«å­˜ | åˆå§‹åº«å­˜ + ç´¯ç©æ·¨è®Šå‹• |
| `åº«å­˜ç‹€æ…‹` | å¥åº·åº¦æŒ‡æ¨™ | æ ¹æ“šæœŸæœ«åº«å­˜åˆ¤æ–· |
| `å»ºè­°æ¡è³¼é‡` | å»ºè­°æ¡è³¼æ•¸é‡ | 60 - æœŸæœ«åº«å­˜ (ç•¶ < 30 ä¸”æœ‰éœ€æ±‚) |

---

## ç¯„ä¾‹è¼¸å‡ºæ ¼å¼

| æœŸé–“ | åº«å­˜åŸºæº–æ—¥ | æœŸåˆåº«å­˜ | éœ€æ±‚ | ä¾›æ‡‰ | æœˆæ·¨è®Šå‹• | é è¨ˆæœŸæœ«åº«å­˜ | åº«å­˜ç‹€æ…‹ | å»ºè­°æ¡è³¼é‡ |
|------|------------|----------|------|------|----------|--------------|----------|------------|
| 202501 | 2025-01-01 | 100 | 40 | 20 | -20 | 80 | ğŸŸ¢ å¥åº· | - |
| 202502 | 2025-02-01 | 80 | 50 | 10 | -40 | 40 | ğŸŸ¢ æ­£å¸¸ | - |
| 202503 | 2025-03-01 | 40 | 30 | 0 | -30 | 10 | ğŸŸ¡ ä½åº«å­˜è­¦å‘Š | 50 |
